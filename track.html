<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Request</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        .icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
        }
        
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .status.show {
            display: block;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-size: 13px;
            color: #666;
        }
        
        .info-box strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="icon">üìç</div>
        <h1>Location Permission Required</h1>
        <p>This link requires your location to continue. Your location will be shared with the sender for educational purposes only.</p>
        
        <button class="btn" id="shareBtn" onclick="shareLocation()">
            üìç Share My Location
        </button>
        
        <div class="status" id="status"></div>
        
        <div class="info-box">
            <strong>üîí Privacy Notice:</strong>
            By clicking "Share My Location", you consent to sharing your precise GPS coordinates. This data will only be used for the purpose stated by the sender. You can deny permission in your browser settings.
        </div>
    </div>

    <script>
        // Get tracking ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const trackingId = urlParams.get('id');
        
        if (!trackingId) {
            document.querySelector('.card').innerHTML = `
                <div class="icon">‚ö†Ô∏è</div>
                <h1>Invalid Link</h1>
                <p>This tracking link is invalid or expired.</p>
            `;
        }
        
        function shareLocation() {
            const btn = document.getElementById('shareBtn');
            const status = document.getElementById('status');
            
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                showStatus('error', '‚ùå Geolocation is not supported by your browser.');
                return;
            }
            
            // Disable button and show loading
            btn.disabled = true;
            showStatus('loading', '<span class="spinner"></span>Getting your location...');
            
            // Request location
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Success - save location
                    const locationData = {
                        trackingId: trackingId,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    };
                    
                    // Save to localStorage (in real app, send to server)
                    saveLocation(locationData);
                    
                    showStatus('success', '‚úÖ Location captured successfully!');
                    
                    // Get redirect URL if any
                    const links = JSON.parse(localStorage.getItem('trackingLinks') || '[]');
                    const link = links.find(l => l.id === trackingId);
                    
                    if (link && link.redirectUrl) {
                        setTimeout(() => {
                            window.location.href = link.redirectUrl;
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            showThankYou(locationData);
                        }, 1500);
                    }
                },
                (error) => {
                    // Error handling
                    btn.disabled = false;
                    let errorMessage = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '‚ùå Location permission denied. Please enable location access in your browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '‚ùå Location information is unavailable. Please check your device settings.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '‚ùå Location request timed out. Please try again.';
                            break;
                        default:
                            errorMessage = '‚ùå An unknown error occurred while getting your location.';
                    }
                    
                    showStatus('error', errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        function saveLocation(locationData) {
            // Get existing locations
            let locations = JSON.parse(localStorage.getItem('locations') || '[]');
            
            // Add new location
            locations.push(locationData);
            
            // Save back to localStorage
            localStorage.setItem('locations', JSON.stringify(locations));
        }
        
        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = 'status show ' + type;
            status.innerHTML = message;
        }
        
        function showThankYou(locationData) {
            document.querySelector('.card').innerHTML = `
                <div class="icon">‚úÖ</div>
                <h1>Thank You!</h1>
                <p>Your location has been successfully shared.</p>
                
                <div class="info-box">
                    <strong>Location Details:</strong>
                    <div style="margin-top: 10px;">
                        üìç Latitude: ${locationData.latitude.toFixed(6)}<br>
                        üìç Longitude: ${locationData.longitude.toFixed(6)}<br>
                        üéØ Accuracy: ¬±${locationData.accuracy.toFixed(0)} meters
                    </div>
                    <div style="margin-top: 15px;">
                        <a href="https://www.google.com/maps?q=${locationData.latitude},${locationData.longitude}" 
                           target="_blank"
                           style="color: #667eea; text-decoration: none; font-weight: 600;">
                            üó∫Ô∏è View on Google Maps ‚Üí
                        </a>
                    </div>
                </div>
                
                <p style="margin-top: 20px; font-size: 14px; color: #999;">
                    You can close this window now.
                </p>
            `;
        }
        
        // Auto-trigger on page load if user previously granted permission
        // This makes it seamless for trusted users
        window.addEventListener('load', () => {
            // Check if user has location permission
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then((result) => {
                    if (result.state === 'granted') {
                        // Auto-share if already granted
                        setTimeout(() => {
                            // Uncomment the line below if you want automatic capture
                            // shareLocation();
                        }, 500);
                    }
                });
            }
        });
    </script>
</body>
</html>
